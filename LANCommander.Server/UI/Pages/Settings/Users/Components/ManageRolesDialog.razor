@using LANCommander.Server.Models
@using Microsoft.EntityFrameworkCore
@using Components
@inject UserService UserService
@inject RoleService RoleService
@inherits FeedbackComponent<Guid, Guid>
@inject IMessageService MessageService
@inject ILogger<ManageRolesDialog> Logger

<Transfer DataSource="TransferItems" TargetKeys="TargetKeys" OnChange="OnChange" Titles="@(new string[] { "Available", "Assigned" })" />

@code {
    User User;
    ICollection<Role> Roles = new List<Role>();
    ICollection<Role> SelectedRoles = new List<Role>();
    IEnumerable<TransferItem> TransferItems { get; set; } = new List<TransferItem>();
    List<string> TargetKeys { get; set; } = new List<string>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            TransferItems = Roles.Select(r => new TransferItem()
            {
                Key = r.Id.ToString(),
                Title = r.Name
            });

            if (SelectedRoles != null)
                TargetKeys = SelectedRoles.Select(i => i.Id.ToString()).ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        User = await UserService.Get(Options);
        Roles = (await RoleService.Get()).ToList();

        var currentRoles = await UserService.GetRoles(User);

        SelectedRoles = Roles.Where(r => currentRoles.Any(cr => r.Name == cr.Name)).ToList();
    }

    async Task OnChange(TransferChangeArgs e)
    {
        SelectedRoles = Roles.Where(r => e.TargetKeys.Contains(r.Id.ToString())).ToList();
    }

    public override async Task OnFeedbackOkAsync(ModalClosingEventArgs args)
    {
        var currentAdmins = await RoleService.GetUsers("Administrator");

        try
        {
            var currentRoles = await UserService.GetRoles(User);

            await UserService.AddToRoles(User, SelectedRoles.Select(r => r.Name).Where(r => !currentRoles.Any(cr => cr.Name == r)));

            foreach (var role in currentRoles)
            {
                if (!SelectedRoles.Any(r => r.Name == role.Name))
                {
                    if (role.Name == "Administrator" && currentAdmins.Any())
                        MessageService.Warning("Cannot demote the only administrator!");
                    else
                        await UserService.RemoveFromRole(User, role);
                }
            }

            MessageService.Success("Updated user roles!");
        }
        catch (Exception ex)
        {
            MessageService.Error("Could not update user roles!");
            Logger.LogError(ex, "Could not update user roles!");
        }

        await base.OkCancelRefWithResult!.OnOk(User.Id);
    }
}