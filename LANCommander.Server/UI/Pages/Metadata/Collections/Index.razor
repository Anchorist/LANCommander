@page "/Metadata/Collections"
@using Microsoft.EntityFrameworkCore;
@using System.Web
@attribute [Authorize(Roles = RoleService.AdministratorRoleName)]
@inject DatabaseServiceFactory DatabaseServiceFactory
@inject NavigationManager NavigationManager
@inject IMessageService MessageService
@inject ILogger<Index> Logger

<PageHeader Title="Collections">
    <PageHeaderExtra>
        <Space Direction="DirectionVHType.Horizontal">
            <SpaceItem>
                <Search Placeholder="Search" @bind-Value="Search" BindOnInput DebounceMilliseconds="150" OnChange="() => LoadData()" />
            </SpaceItem>
            <SpaceItem>
                <Button OnClick="OpenAdd" Type="@ButtonType.Primary">Add Collection</Button>
            </SpaceItem>
        </Space>
    </PageHeaderExtra>
</PageHeader>

<TableColumnPicker @ref="Picker" Key="Collections" @bind-Visible="ColumnPickerVisible" />

<Table
    TItem="Collection"
    DataSource="@Collections"
    Loading="@Loading"
    PageSize="@PageSize"
    PageIndex="@PageIndex"
    Total="@TotalCount"
    OnPageIndexChange="PageIndexChanged"
    OnPageSizeChange="PageSizeChanged"
    Size="@TableSize.Small"
    Responsive>
    <PropertyColumn Property="c => c.Name" Sortable Hidden="@(Picker.IsColumnHidden("Name"))" />
    <PropertyColumn Property="c => c.CreatedOn" Format="MM/dd/yyyy hh:mm tt" Sortable Hidden="@(Picker.IsColumnHidden("Created On"))" />
    <PropertyColumn Property="c => c.CreatedBy != null ? c.CreatedBy.UserName : String.Empty" Title="Created By" Sortable Hidden="@(Picker.IsColumnHidden("Created By"))" />
    <PropertyColumn Property="c => c.UpdatedOn" Format="MM/dd/yyyy hh:mm tt" Sortable Hidden="@(Picker.IsColumnHidden("Updated On", false))" />
    <PropertyColumn Property="c => c.UpdatedBy != null ? c.UpdatedBy.UserName : String.Empty" Title="Updated By" Sortable Hidden="@(Picker.IsColumnHidden("Updated By"))" />
    <Column Title="Games" TData="int">
        @context.Games?.Count
    </Column>
    <ActionColumn Title="" Style="text-align: right; white-space: nowrap">
        <TitleTemplate>
            <div style="text-align: right">
                <Button Icon="@IconType.Outline.Edit" Type="@ButtonType.Text" OnClick="() => OpenColumnPicker()" />
            </div>
        </TitleTemplate>
        <ChildContent>
            <Space Direction="DirectionVHType.Horizontal">
                <SpaceItem>
                    <a href="/Metadata/Collections/@(context.Id)" class="ant-btn ant-btn-primary">Edit</a>
                </SpaceItem>
                <SpaceItem>
                    <Popconfirm OnConfirm="() => Delete(context)" Title="Are you sure you want to delete this Collection?">
                        <Button Icon="@IconType.Outline.Close" Type="@ButtonType.Text" Danger />
                    </Popconfirm>
                </SpaceItem>
            </Space>
        </ChildContent>
    </ActionColumn>
</Table>

<Modal Title="Add Collection" OnOk="Add" OnCancel="CloseAdd" @bind-Visible="AddCollectionVisible">
    <Form Model="@CollectionContext">
        <FormItem Label="Name">
            <Input @bind-Value="@context.Name" />
        </FormItem>
    </Form>
</Modal>

 @code {
    IEnumerable<Collection> Collections { get; set; } = new List<Collection>();

    bool Loading = true;
    int PageIndex = 1;
    int PageSize = 50;
    int TotalCount = 0;

    string Search = "";
    string Url;

    TableColumnPicker Picker;
    bool ColumnPickerVisible = false;

    bool AddCollectionVisible = false;
    Collection CollectionContext = new Collection();

    protected override async Task OnInitializedAsync()
    {
        Url = NavigationManager.Uri;
        NavigationManager.LocationChanged += LocationChanged;
        LoadTableParameter();
        await LoadData();

        Loading = false;
    }

    async Task LoadData()
    {
        var fuzzySearch = Search.ToLower().Trim();

        using (var collectionService = DatabaseServiceFactory.Create<CollectionService>())
        {
            var results = await collectionService
                .Include(s => s.CreatedBy)
                .Include(s => s.UpdatedBy)
                .SortBy(t => t.Name)
                .PaginateAsync(t => t.Name.ToLower().Contains(fuzzySearch),
                    PageIndex,
                    PageSize);

            TotalCount = results.Count;
            Collections = results.Results;
        }
    }

    async void LocationChanged(object sender, LocationChangedEventArgs e)
    {
        Url = e.Location;
        LoadTableParameter();
        await LoadData();
    }

    void LoadTableParameter()
    {
        var uri = NavigationManager.ToAbsoluteUri(Url);
        var query = HttpUtility.ParseQueryString(uri.Query);

        PageIndex = int.TryParse(query["Page"], out var index) ? index > 0 ? index : 1 : 1;
        PageSize = int.TryParse(query["Size"], out var size) ? size > 0 ? size : 50 : 50;

        if (query["Search"] != null)
            Search = query["Search"];
        else
            Search = "";
    }

    void PageIndexChanged(PaginationEventArgs args)
    {
        NavigationManager.NavigateTo($"/Metadata/Collections?Page={args.Page}&Size={args.PageSize}{(Search != "" ? "&Search=" + Search : "")}");
    }

    void PageSizeChanged(PaginationEventArgs args)
    {
        NavigationManager.NavigateTo($"/Metadata/Collections?Page={args.Page}&Size={args.PageSize}{(Search != "" ? "&Search=" + Search : "")}");
    }

    void SearchChanged()
    {
        NavigationManager.NavigateTo($"/Metadata/Collections?Search={Search}&Size={PageSize}");
    }

    async Task OpenAdd()
    {
        CollectionContext = new Collection();

        AddCollectionVisible = true;

        await InvokeAsync(StateHasChanged);
    }

    async Task CloseAdd()
    {
        AddCollectionVisible = false;

        await InvokeAsync(StateHasChanged);
    }

    async Task Add()
    {
        try
        {
            using (var collectionService = DatabaseServiceFactory.Create<CollectionService>())
            {
                await collectionService.AddMissingAsync(x => x.Name == CollectionContext.Name, CollectionContext);
            }

            MessageService.Success($"{CollectionContext.Name} was added!");

            await LoadData();

            await CloseAdd();
        }
        catch (Exception ex)
        {
            MessageService.Error($"Could not add {CollectionContext.Name}!");
            Logger.LogError(ex, $"Could not add {CollectionContext.Name}!");
        }
    }

    async Task Delete(Collection Collection)
    {
        Collections = new List<Collection>();

        Loading = true;

        using (var collectionService = DatabaseServiceFactory.Create<CollectionService>())
        {
            await collectionService.DeleteAsync(Collection);
        }

        await LoadData();

        Loading = false;
    }

    async Task OpenColumnPicker()
    {
        ColumnPickerVisible = true;
    }

    async Task CloseColumnPicker()
    {
        ColumnPickerVisible = false;
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= LocationChanged;
    }
}
