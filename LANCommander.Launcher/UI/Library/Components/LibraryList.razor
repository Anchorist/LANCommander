@using LANCommander.Launcher.Models
@using LANCommander.Launcher.Services.Extensions
@inject LibraryService LibraryService
@inject ImportService ImportService
@inject MessageBusService MessageBusService

<Flex Vertical Class="library-list">
    <Collapse>
        @if (Groups.Count > 1)
        {
            foreach (var group in Groups.OrderByTitle(g => g))
            {
                <Panel Header="@group" Key="@group">
                    <AntList DataSource="@(LibraryItems.Where(i => i.Groups.Contains(group) || (group == "Uncategorized" && !i.Groups.Any())))" TItem="LibraryItem" Class="ant-list-clickable" Size="small">
                        <LibraryListItem Model="@context" OnClick="() => SelectItem(context)" @bind-SelectedItem="SelectedItem" />
                    </AntList>
                </Panel>
            }
        }
        else
        {
            <Panel Class="no-header">
                <AntList DataSource="LibraryItems" TItem="LibraryItem" Class="ant-list-clickable" Size="small">
                    <LibraryListItem Model="@context" OnClick="() => SelectItem(context)" @bind-SelectedItem="SelectedItem" />
                </AntList>
            </Panel>
        }
    </Collapse>
    
    <LibraryItemFilter />
</Flex>

@code {
    [Parameter] public Guid? SelectedItem { get; set; }
    [Parameter] public EventCallback<Guid> OnItemSelected { get; set; }

    string Search { get; set; } = "";
    List<string> Groups = new List<string>();
    IEnumerable<LibraryItem> LibraryItems;

    protected override async Task OnInitializedAsync()
    {
        LibraryService.OnLibraryItemsFiltered += LoadFilteredItems;

        await LibraryService.RefreshLibraryItemsAsync();
    }

    async Task LoadFilteredItems(IEnumerable<LibraryItem> libraryItems)
    {
        LibraryItems = libraryItems;

        await UpdateGroups();
        await InvokeAsync(StateHasChanged);
    }

    async Task SelectItem(LibraryItem item)
    {
        if (OnItemSelected.HasDelegate)
            await OnItemSelected.InvokeAsync(item.Key);
    }

    async Task UpdateGroups()
    {
        Groups = LibraryItems.SelectMany(i => i.Groups).Distinct().ToList();

        if (LibraryItems.Any(i => i.Groups == null || i.Groups.Length == 0))
            Groups.Add("Uncategorized");

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        LibraryService.OnLibraryItemsFiltered -= LoadFilteredItems;
    }
}